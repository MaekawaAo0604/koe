# Requirements Document

## はじめに

Koe（声）は、日本初のテスティモニアル（お客様の声）収集・管理・Webサイト埋め込みをワンストップで提供するSaaSである。フリーランス・個人開発者をメインターゲットとし、フォームURL共有→自動収集→scriptタグ1行埋め込みという3ステップで完了する手軽さを最大の価値とする。Free / Pro（¥980/月）の2プラン構成で、PLG（Powered by Koeバッジ経由の自然流入）による成長を狙う。

本ドキュメントはKoe MVPに必要な全機能要件をEARS形式で定義する。

---

## 要件一覧

### 要件1: ユーザー認証

**ユーザーストーリー:** サービス提供者として、メールアドレスまたはGoogleアカウントで簡単にサインアップ・サインインしたい。安全にアカウントを管理できるようにしたい。

#### 受け入れ基準

1. WHEN ユーザーがサインアップフォームにメールアドレスとパスワード（8文字以上）と名前を入力して送信する THEN システムは Supabase Auth にユーザーを作成し、確認メールを送信し、`public.users` にプロファイルを自動作成 SHALL する
2. WHEN ユーザーが確認メール内のリンクをクリックする THEN システムはメールアドレスを確認済みにし、ダッシュボードへリダイレクト SHALL する
3. WHEN ユーザーが「Googleでログイン」ボタンをクリックする THEN システムは Google OAuth フローを開始し、認証成功後にダッシュボードへリダイレクト SHALL する
4. WHEN ユーザーがサインインフォームに正しいメールアドレスとパスワードを入力する THEN システムはセッションを作成し、ダッシュボードへリダイレクト SHALL する
5. WHEN ユーザーが「パスワードを忘れた」リンクをクリックしてメールアドレスを入力する THEN システムはパスワードリセットメールを送信 SHALL する
6. WHEN ユーザーがパスワードリセットメール内のリンクから新しいパスワードを設定する THEN システムはパスワードを更新し、サインイン画面へリダイレクト SHALL する
7. WHEN 認証済みユーザーがサインアウトボタンをクリックする THEN システムはセッションを破棄し、トップページへリダイレクト SHALL する
8. IF ユーザーが未認証の状態でダッシュボード等の認証必須ページにアクセスする THEN システムはサインインページへリダイレクト SHALL する
9. WHILE ユーザーのセッションが有効である間 THE SYSTEM SHALL Supabase Auth のトークン自動更新機能によりセッションを維持する

---

### 要件2: プロジェクト管理

**ユーザーストーリー:** サービス提供者として、テスティモニアルを収集するプロジェクトを作成・管理したい。プロジェクトごとに収集フォームやブランド設定を分けたい。

#### 受け入れ基準

1. WHEN 認証済みユーザーがダッシュボードにアクセスする THEN システムはそのユーザーが所有するプロジェクト一覧を、各プロジェクトのテスティモニアル件数と共に表示 SHALL する
2. WHEN ユーザーが「新しいプロジェクト作成」ボタンをクリックし、プロジェクト名を入力する THEN システムはプロジェクトを作成し、スラッグ（URLスラフ）を自動生成 SHALL する
3. WHEN ユーザーがプロジェクト設定画面でプロジェクト名、ロゴ、ブランドカラーを編集して保存する THEN システムは設定を更新 SHALL する
4. WHEN ユーザーがプロジェクト設定画面でフォームURL（`/f/:slug`）のコピーボタンをクリックする THEN システムはフォームURLをクリップボードにコピー SHALL する
5. WHEN ユーザーがプロジェクトの削除を実行する THEN システムは確認ダイアログを表示し、確認後にプロジェクトと関連するテスティモニアル・ウィジェットをすべて削除 SHALL する
6. IF ユーザーのプランがFreeである THEN システムはプロジェクト数を1つに制限 SHALL する
7. IF ユーザーのプランがProである THEN システムはプロジェクト数を無制限で作成可能に SHALL する
8. WHEN ユーザーがブランドカラーを設定する THEN システムは有効な16進数カラーコード（`#` + 6桁）のみ受け付け SHALL する
9. WHEN ユーザーがスラッグを設定する THEN システムは小文字英数字とハイフンのみ（3〜50文字）で構成されたスラッグのみ受け付け、一意性を保証 SHALL する

---

### 要件3: テスティモニアル収集フォーム

**ユーザーストーリー:** エンドユーザー（お客さん）として、簡単にテスティモニアルを送信したい。サービス提供者として、ブランドに合った収集フォームを提供したい。

#### 受け入れ基準

1. WHEN エンドユーザーがフォームURL（`/f/:slug`）にアクセスする THEN システムは該当プロジェクトのブランド設定に合わせた収集フォームを1秒以内に表示 SHALL する
2. WHEN エンドユーザーがフォームに名前（必須）、★評価（1-5、必須）、感想テキスト（必須）、会社名（任意）、役職（任意）、メールアドレス（任意）、顔写真（任意）を入力して送信する THEN システムはテスティモニアルをステータス `pending` で保存 SHALL する
3. WHEN テスティモニアルが正常に保存される THEN システムはサンクスメッセージ画面（「ご協力ありがとうございました！」）を表示 SHALL する
4. IF ユーザーのプランがFreeである THEN システムは収集フォームに「Powered by Koe」バッジを表示 SHALL する
5. WHEN エンドユーザーが★評価に1未満または5超の値を入力しようとする THEN システムはバリデーションエラーを表示し、送信を拒否 SHALL する
6. WHEN エンドユーザーが名前または感想テキストを空で送信しようとする THEN システムはバリデーションエラーを表示し、送信を拒否 SHALL する
7. WHEN 同一IPアドレスから1時間以内に11件以上のテスティモニアルが投稿される THEN システムはHTTP 429エラーを返し、投稿を拒否 SHALL する（レートリミット: 10件/時間/IP）
8. WHEN エンドユーザーが顔写真をアップロードする THEN システムは2MB以下の画像ファイルのみ受け付け、Supabase Storageに保存 SHALL する
9. WHEN 存在しないスラッグのフォームURLにアクセスする THEN システムは404エラーページを表示 SHALL する
10. IF プロジェクトオーナーのプランがFreeで、該当プロジェクトのテスティモニアルが既に10件に達している THEN システムは投稿を拒否し、上限到達のエラーメッセージを表示 SHALL する

---

### 要件4: テスティモニアル管理画面

**ユーザーストーリー:** サービス提供者として、収集したテスティモニアルを一覧で確認し、承認・非承認・タグ付けなどの管理操作を行いたい。

#### 受け入れ基準

1. WHEN プロジェクトオーナーがテスティモニアル管理画面にアクセスする THEN システムはそのプロジェクトの全テスティモニアルをカード形式の一覧で、作成日時の降順に表示 SHALL する
2. WHEN プロジェクトオーナーがテスティモニアルの「承認」ボタンをクリックする THEN システムはそのテスティモニアルのステータスを `approved` に更新 SHALL する
3. WHEN プロジェクトオーナーがテスティモニアルの「非承認」ボタンをクリックする THEN システムはそのテスティモニアルのステータスを `rejected` に更新 SHALL する
4. WHEN プロジェクトオーナーがテスティモニアルにタグを追加する THEN システムはタグを保存し、以後そのタグでフィルタ可能に SHALL する
5. WHEN プロジェクトオーナーが一覧画面で★評価、承認状態、またはタグでフィルタを適用する THEN システムはフィルタ条件に合致するテスティモニアルのみ表示 SHALL する
6. WHEN プロジェクトオーナーがテスティモニアルの表示名を編集する THEN システムは更新された表示名を保存 SHALL する
7. WHEN プロジェクトオーナーがテスティモニアルを削除する THEN システムは確認ダイアログを表示し、確認後にそのテスティモニアルを完全削除 SHALL する
8. IF ユーザーのプランがFreeである THEN システムはテスティモニアル一覧の上部に現在の件数と上限（例: 「3 / 10 件」）を表示 SHALL する
9. WHILE プロジェクトオーナーが管理画面を操作している間 THE SYSTEM SHALL テスティモニアルの `author_email` をオーナーのみに表示し、公開APIやウィジェットには含めない

---

### 要件5: 埋め込みウィジェット

**ユーザーストーリー:** サービス提供者として、承認済みのテスティモニアルを自分のWebサイトにscriptタグ1行で簡単に埋め込みたい。デザインもカスタマイズしたい。

#### 受け入れ基準

1. WHEN プロジェクトオーナーがウィジェット設定画面でウィジェットタイプ（Wall of Love / カルーセル / リスト）を選択する THEN システムは選択されたタイプでプレビューを表示 SHALL する
2. WHEN プロジェクトオーナーがウィジェットのデザイン（テーマ、カラー、角丸、影、フォント）をカスタマイズする THEN システムはリアルタイムプレビューに反映 SHALL する
3. WHEN プロジェクトオーナーが埋め込みコードのコピーボタンをクリックする THEN システムは `<script src="https://koe.example.com/widget.js" data-project="xxx" data-widget="yyy"></script>` 形式の埋め込みコードをクリップボードにコピー SHALL する
4. WHEN 埋め込みコードがサードパーティのWebサイトに設置される THEN widget.js はShadow DOM内にウィジェットをレンダリングし、ホストサイトのCSSとの干渉を防止 SHALL する
5. WHEN widget.js がロードされる THEN システムはウィジェットAPIから承認済みテスティモニアルのみを取得し、200ms以内にデータを返却 SHALL する
6. IF プロジェクトオーナーのプランがFreeである THEN ウィジェットには「Powered by Koe」バッジを表示 SHALL する
7. IF プロジェクトオーナーのプランがProである THEN ウィジェットの「Powered by Koe」バッジを非表示にできる SHALL する
8. IF プロジェクトオーナーのプランがFreeである THEN システムはウィジェットタイプをWall of Loveのみに制限 SHALL する
9. IF プロジェクトオーナーのプランがProである THEN システムは全ウィジェットタイプ（Wall of Love、カルーセル、リスト）を利用可能に SHALL する
10. WHILE ウィジェットがサードパーティサイトに埋め込まれている間 THE SYSTEM SHALL ウィジェットデータをCDNキャッシュ（5分TTL）で配信し、パフォーマンスを維持する
11. WHERE widget.js がブラウザにロードされる THE SYSTEM SHALL gzip後30KB以下のファイルサイズを維持する
12. WHEN ウィジェットAPIがテスティモニアルデータを返却する THEN システムは `author_email` を含めず、公開可能な情報のみ返却 SHALL する

---

### 要件6: Wall of Love ページ

**ユーザーストーリー:** サービス提供者として、承認済みテスティモニアルをまとめた専用の公開ページを持ち、URLを共有したい。

#### 受け入れ基準

1. WHEN プロジェクトオーナーがWall of Loveページ設定を有効にする THEN システムは公開URL（例: `/wall/:slug`）を生成 SHALL する
2. WHEN 誰かがWall of Loveの公開URLにアクセスする THEN システムはそのプロジェクトの承認済みテスティモニアルをグリッド形式で表示 SHALL する
3. IF プロジェクトオーナーのプランがFreeである THEN Wall of Loveページには「Powered by Koe」バッジを表示 SHALL する
4. WHEN プロジェクトオーナーがウィジェット設定画面でWall of Love公開ページURLのコピーボタンをクリックする THEN システムはURLをクリップボードにコピー SHALL する

---

### 要件7: 課金（Stripe連携）

**ユーザーストーリー:** サービス提供者として、Free→Proへのアップグレードやサブスクリプション管理を簡単に行いたい。

#### 受け入れ基準

1. WHEN Freeプランのユーザーが「Proにアップグレード」ボタンをクリックする THEN システムはStripe Checkout セッションを作成し、Stripeの決済ページへリダイレクト SHALL する
2. WHEN ユーザーがStripe Checkoutで決済を完了する THEN システムはWebhook（`checkout.session.completed`）経由で `users.plan` を `pro` に更新し、`subscriptions` レコードを作成 SHALL する
3. WHEN 決済完了後にユーザーがアプリに戻る THEN システムは「処理中...」を表示し、プラン更新を確認するまでポーリング SHALL する
4. WHEN Proプランのユーザーが「プランを管理」ボタンをクリックする THEN システムはStripe Customer Portal セッションを作成し、Portalページへリダイレクト SHALL する
5. WHEN ユーザーがCustomer Portalでサブスクリプションをキャンセルする THEN システムはWebhook経由でサブスクリプションのステータスを `canceled` に更新し、`current_period_end` まではPro機能を利用可能に SHALL する
6. WHEN キャンセル済みサブスクリプションの期間が終了する THEN システムはWebhook（`customer.subscription.deleted`）経由で `users.plan` を `free` に戻す SHALL する
7. WHEN 自動更新の課金が失敗する THEN システムはWebhook（`invoice.payment_failed`）経由でサブスクリプションのステータスを `past_due` に更新 SHALL する
8. WHEN 支払い失敗後にStripe Smart Retriesで支払いが成功する THEN システムはWebhook（`invoice.payment_succeeded`）経由でステータスを `active` に復帰させる SHALL する
9. IF 既にProプランのユーザーがCheckoutを実行しようとする THEN システムはHTTP 400エラーを返す SHALL する
10. WHEN Stripe Webhookイベントを受信する THEN システムは署名検証を必ず実行し、検証失敗時はHTTP 400を返す SHALL する
11. WHEN 同一のStripe WebhookイベントIDが複数回配信される THEN システムは冪等性チェックにより重複処理を防止 SHALL する
12. WHEN ユーザーが課金画面にアクセスする THEN システムは現在のプラン（Free / Pro）、サブスクリプションステータス、次回請求日を表示 SHALL する
13. IF サブスクリプションのステータスが `past_due` である THEN システムは管理画面にバナーで支払い失敗を通知 SHALL する

---

### 要件8: LPページ（マーケティング）

**ユーザーストーリー:** 潜在ユーザーとして、Koeのサービス内容、料金プラン、使い方を把握し、安心して無料で始めたい。

#### 受け入れ基準

1. WHEN 未認証ユーザーがトップページにアクセスする THEN システムはサービス説明、デモのWall of Love（ドッグフーディング）、料金プラン比較、「無料で始める」CTAを表示 SHALL する
2. WHEN ユーザーが「無料で始める」CTAボタンをクリックする THEN システムはサインアップページへリダイレクト SHALL する
3. WHEN ユーザーが料金プランセクションを閲覧する THEN システムはFreeプランとProプラン（¥980/月）の機能比較表を表示 SHALL する

---

### 要件9: セキュリティ・非機能要件

**ユーザーストーリー:** サービス提供者として、安全で高速なサービスを利用したい。

#### 受け入れ基準

1. WHILE ユーザーがアプリケーションを利用している間 THE SYSTEM SHALL RLS（Row Level Security）により、各ユーザーが自分のデータのみアクセス可能であることを保証する
2. WHILE システムが稼働している間 THE SYSTEM SHALL `service_role` キーをサーバーサイドでのみ使用し、クライアントに露出させない
3. WHEN テスティモニアルフォームから投稿される THEN システムはステータスを `pending` に強制し、`approved` や `rejected` での直接投稿を拒否 SHALL する（RLS WITH CHECKによる強制）
4. WHERE ウィジェットAPIがテスティモニアルデータを返却する THE SYSTEM SHALL `author_email` を除外し、公開可能なフィールドのみ返却する
5. WHILE ウィジェットデータが配信されている間 THE SYSTEM SHALL Vercel Edge Cache（`s-maxage=300, stale-while-revalidate=60`）によりレスポンスをキャッシュする
6. WHEN Stripe Webhook を受信する THEN システムは署名検証を実行し、`stripe_events` テーブルで冪等性を管理 SHALL する
7. WHILE フォーム投稿を受け付けている間 THE SYSTEM SHALL IPベースのレートリミット（10件/時間）を適用する
8. WHEN ユーザーがファイルをアップロードする THEN システムはアバター画像は2MB以下、ロゴ画像は5MB以下に制限 SHALL する

---

### 要件10: Powered by Koe バッジ（PLG）

**ユーザーストーリー:** Koe運営者として、Freeプランユーザーのウィジェットやフォームに「Powered by Koe」バッジを表示し、自然な認知拡大を実現したい。

#### 受け入れ基準

1. IF プロジェクトオーナーのプランがFreeである THEN システムは埋め込みウィジェット、収集フォーム、Wall of Loveページのすべてに「Powered by Koe」バッジを表示 SHALL する
2. WHEN 訪問者が「Powered by Koe」バッジをクリックする THEN システムはKoeのLPページ（UTMパラメータ付き）へ遷移 SHALL する
3. IF プロジェクトオーナーのプランがProである THEN システムは「Powered by Koe」バッジを非表示に SHALL する
4. WHILE ウィジェットがShadow DOM内にレンダリングされている間 THE SYSTEM SHALL バッジをウィジェット内に含め、ホストサイトのCSSで非表示にされることを防止する
