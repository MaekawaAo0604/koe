# Google Tag Manager で Koe を埋め込む

サイトのコードを直接編集できない場合、Google Tag Manager（GTM）経由でKoeを埋め込むことができます。

> **注意**: GTM経由の場合、広告ブロッカー（Adblock等）によってスクリプトがブロックされる場合があります。**表示の確実性を求める場合は、サイトへの直接貼り付けを推奨します**。→ [クイックスタート](quickstart.md)

---

## 手順

### 1. GTM にログイン

[Google Tag Manager](https://tagmanager.google.com/) にログインし、対象のコンテナを選択します。

### 2. 新しいタグを作成

1. 左メニュー →「タグ」→「新規」をクリック
2. タグ名を入力: `Koe ウィジェット`

### 3. タグの設定

1. 「タグの設定」をクリック
2. タグタイプは「カスタム HTML」を選択
3. HTML 欄に以下を貼り付け:

```html
<script src="https://あなたのURL/widget.js" data-project="あなたのプロジェクトID" data-widget="あなたのウィジェットID"></script>
```

4. 「`document.write` をサポートする」のチェックは**外したまま**にしてください

### 4. トリガーの設定

1. 「トリガー」をクリック
2. 全ページに表示する場合: 「All Pages」を選択
3. 特定のページに表示する場合: 「新規」→「ページビュー」→ URL条件を指定

### 5. 保存・プレビュー・公開

1. 右上の「保存」をクリック
2. 「プレビュー」でタグが発火していることを確認
3. 問題なければ「送信」→「公開」

---

## 広告ブロッカーに関する注意

GTM 経由でスクリプトを読み込む場合、以下の理由で表示されないことがあります:

- **広告ブロッカー（Adblock, uBlock Origin等）** が `googletagmanager.com` からの読み込み自体をブロック
- GTMがブロックされると、GTM経由のタグ（Koe含む）が一切読み込まれない

### 対策

| 方法 | 確実性 | 難易度 |
|------|--------|--------|
| **サイトに直接貼る**（推奨） | 高 | コード編集が必要 |
| GTM + サーバーサイドGTM | 中〜高 | 設定が複雑 |
| GTM のみ | 低〜中 | 簡単だがブロックリスク |

**結論**: 表示の確実性を求めるなら、[プラットフォーム別の直接埋め込み](quickstart.md) を使ってください。GTMは「コードを触れない」場合の次善策です。

---

## GTM でうまく表示されない場合

### プレビューモードでタグが発火しない

- トリガーの条件（URL、ページタイプ等）を確認してください
- タグの「カスタム HTML」にコードが正しく貼られているか確認

### タグは発火するが表示されない

- ブラウザの DevTools → Console にエラーが出ていないか確認
- Content Security Policy (CSP) で外部スクリプトがブロックされている可能性 → [トラブルシューティング](troubleshooting.md) を参照

その他の問題は [トラブルシューティング](troubleshooting.md) を参照してください。
